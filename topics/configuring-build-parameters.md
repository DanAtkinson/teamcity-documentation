[//]: # (title: Configuring Build Parameters)
[//]: # (auxiliary-id: Configuring Build Parameters)
[//]: # (Internal note. Do not delete. "Configuring Build Parametersd72e3.txt")

Intro - briefly explain difference between config parameters and env variables:

* Conf Parameters — store settings of the TeamCity build configuration
* Env variables — passed to the process of a build runner similarly to default env variables of a system.

Show people how they can use parameters to better illustrate the difference (if there's any)

Where in TeamCity can you use parameters:

## Specify Agent Requirements


* Purpose: specify which agents can build this configuration
* Only predefined parameters
* Cannot use user-defined parameters (why?)
* Accepted parameter types: configuration params only.

UI:

Screenshot here

Kotlin:

```Kotlin
import jetbrains.buildServer.configs.kotlin.*

object BuildConfig : BuildType({
    name = "Build Config"
    steps { 
        // Build steps
    }

    requirements {
        // Requirements in the following format:
        // Operator("ParameterName", "ParameterValue")
    }
})
```

Examples:

Allows builds to run only on Linux agents (TCC only!)

```Kotlin
matches("teamcity.agent.jvm.os.family", "Linux")
```

Allows builds to run on Mac agents only (On-Prem)

```Kotlin
startsWith("teamcity.agent.jvm.os.name", "Mac")
```

Allows builds to run only on machines with "Android" workload installed for .NET 7 SDK:

```Kotlin
contains("DotNetWorkloads_7.0", "android")
```

Allows builds to run only on agents with installed Docker or Podman:

```Kotlin
exists("container.engine")
```


## Specify Step Execution Conditions


* Purpose: specify whether or not this step should be executed
* Accepted parameter types: configuration parameters (predefined &amp; custom)

UI:

Screenshot here

Kotlin:

```Kotlin
object MyBuildConfig : BuildType({

    steps {
        script {
            name = "CLI Script Runner"
    
            conditions {
                // Parameter-based condidion in the following format:
                // Operator("ParameterName", "ParameterValue")
                // For example: equals("container.engine", "podman")
            }
        }
    }
})
```

## Passing Data Between Steps


* Purpose: pass a value obtained during one step to the next step


```Shell
echo "##teamcity[setParameter name='myParam1' value='TeamCity Agent %\teamcity.agent.name%']"
```
{interpolate-variables="false"}

Example: ??? Need a good use case here

## Passing Data Between Builds in a Build Chain


* Purpose: pass data generated by one build so that it can be used by a next (dependent) build

Example:

First build (build configuration ID is "ConfigA"):

```Shell
TAG=v1
docker build -f Dockerfile --tag your.registry/MyApp:${TAG}
docker push your.registry/MyApp:v1
echo "##teamcity[setParameter name='DockerImageName' value='MyApp:${TAG}']"
```
{interpolate-variables="false"}

Dependent build (has a snapshot dependency to the first build):

```Shell
docker run -d your.registry/%\dep.ConfigA.DockerImageName%
```
{interpolate-variables="false"}

Example 2:

TBD -- artifact dependencies, need a nice use case



## Inside Build Scripts

* Purpose: pass a specific value to the build process, and use this value inside commands
* Accepted parameter types: both config and env ?????

Examples

### C# Script Runner

Using env variables:

```C#
Console.WriteLine("Predefined variable value = " + System.Environment.GetEnvironmentVariable("TEAMCITY_VERSION"));
Console.WriteLine("Custom variable value = " + System.Environment.GetEnvironmentVariable("My.Custom.Env.Variable"));
```
{interpolate-variables="false"}

Using configuration parameters:

```C#
string fullPath = Path.Combine("%\teamcity.build.checkoutDir%", "myFolder/bin");
Console.WriteLine(fullPath);
```
{interpolate-variables="false"}

Passing parameter values to the global `Args` array: add parameter references in the `%\parameter_name%` format to the "Script parameters" field of the runner.

Example: the `%\nuget.package.name%` is added to "Script parameters". Restore NuGet package, get its version, and calculate the next version number. This value can later be used for building and pushing a package.
{interpolate-variables="false"}

```C#
using System.Linq
Props["version"] =
    GetService<INuGet>()
    .Restore(Args[0], "*", "net6.0"
    .Where(i => i.Name == Args[0])
    .Select(i => i.Version)
    .Select(i => new Version(i.Major,i.Minor,i.Build+1))
    .DefaultIfEmpty(new Version[1,0,0])
    .Max()
    .ToString();
Console.WriteLine($"Version number: {Props["version"]}", Success)
```
{interpolate-variables="false"}

### Command Line Runner

Report values of a checkout directory (config parameter) and TeamCity server version (env variable)

```Shell
echo "Checkout directory: %\teamcity.build.checkoutDir%"
echo "Server version: '$TEAMCITY_VERSION'"
```
{interpolate-variables="false"}

Copy a file

```Shell
set -e -x

FILE=%\teamcity.build.branch%/fileToCopy.xml
if test -f "$FILE"; then
    cp "$FILE" folderA/folderB
fi
```

Download an "libraries.tar.gz" archive from the server whose URL is stored as the `serverURL` config parameter, and save it to the checkout directory with the build number in its name (for example, the archive's name for build #54 will be "libraries_54.tar.gz"):

```Shell
curl -o libraries_%\build.number%.tar.gz %\serverUrlBase%libraries.tar.gz
```




### Python Runner

Config parameter:

```Python
print(f'Current checkout directory is: %\teamcity.build.checkoutDir%')
```

Env variable:

```Python
print(f'TeamCity version is: %\env.TEAMCITY_VERSION%')
# or
print(f"TeamCity version is: {os.environ['TEAMCITY_VERSION']}")
```



### Ant, Maven, NAnt Runners

Use `${parameterName}` inside build script files

Current docs say parameters are passed without "env." prefix, but I can actually find these in our space repo build files:

```XML
<properties>
    <test.property>${env.MY_TEST_VAR}</test.property>
    <testProperty>${test.property}</testProperty>
</properties>

<echo message="${env.ENV_PARAM}" level="info"/>
<echo message="${SYSTEM_PARAM}" level="info"/>

<condition property="javadocPath" value="${env.JDK_11}/bin/javadoc" >
```

Examples:

Ant

```XML
<target name="buildmain">
    <ant dir="${teamcity.build.checkoutDir}" antfile="${teamcity.build.checkoutDir}/build-test.xml" target="masterbuild_main"/>
</target>
```

Maven

```XML
<!--pom.xml file-->
<build>
    <plugins>
        <plugin>
            <artifactId>maven-antrun-plugin</artifactId>
            <version>1.3</version>
            <executions>
                <execution>
                    <phase>generate-sources</phase>
                    <configuration>
                        <tasks>
                            <property environment="env"/>
                            <echo message="TEMP = ${env.TEMP}"/>
                            <echo message="TMP = ${env.TMP}"/>
                            <echo message="java.io.tmpdir = ${java.io.tmpdir}"/>
                            <echo message="build.number = ${build.number}"/>
                        </tasks>
                    </configuration>
                    <goals>
                        <goal>run</goal>
                    </goals>
                </execution>
            </executions>
        </plugin>
    </plugins>
</build>
```


### .NET Runner

???


## Additional Runner Arguments and Settings

* Purpose: specify additional runner settings, such as command arguments. For example, additional arguments for "mvn build" command that a Maven build executes.
* Accepted properties: all (?????) env.JDK_VER_PATH variables seems legit

UI:

Use corresponding fields in the TeamCity UI.

Examples:

Specify the additional "OutputType" property for the .NET `build` command.

```Kotlin
object MyBuildConfig : BuildType({
    params {
        param("DotNetOutputType", "WinExe")
    }

    steps {
        dotnetBuild {
            args = "-p:OutputType=%\DotNetOutputType%"
        }
    }
})
```

Define two Maven variables

```Kotlin
steps {
    maven {
        goals = "-nsu -e -Pbuildserver -DBUILD_NUMBER=%\build.number% -DskipTests=%\mvn.skip.tests% generate-resources"
        pomLocation = "build-version/pom.xml"
    }
}
```

Specify the specific JDK version the Gradle runner should use

```Kotlin
steps {
    gradle {
        name = "Gradle step"
        tasks = "build-dist"
        jdkHome = "%\env.JDK_19_0_ARM64%"
    }
}
```





## Custom Build Numbers and Tags

Custom build number: Conf Settings | General Settings | Build Number format

Only predefined server build parameters

UI:

Screenshot here

Kotlin:

??? The if not env. variable, then it's system.teamcity.buildConfName, and we're hiding system — OK to use env here ???

```Kotlin
object MyBuildConf : BuildType({
    buildNumberPattern = "%\build.counter%-%\env.TEAMCITY_BUILDCONF_NAME%"
})
```

Labeling: Conf settings | Build Features | Add | VCS Labeling

UI:

Screenshot here

Kotlin:

```Kotlin
object MyBuildConf : BuildType({
    features {
        vcsLabeling {
            vcsRootId = "${UrlRefsHeadMaster.id}"
            labelingPattern = "TC-build-%\build.number%"
        }
    }
})
```


## VCS Root and Checkout Rule Settings

VCS root settings - tried creating the new "branch.default" parameter that equals "refs/heads/master" and referencing this parameter in the "Default branch". Fires the "Test connection failed in Parameters Test / Gradle
Cannot find revision of the default branch '%\branch.default%'" error.

Example: Custom Path to git in VCS Root settings

UI: Screenshot

`Path to git = %\CustomMyGitPath%`

Kotlin:

```Kotlin
object MyBuildConf : BuildType({
    params {
        param("env.CustomMyGitPath", "path/to/required/git/version")
    }

    // ??? No vcs root settings visible

})
```

Checkout rules:

UI: Build Conf Settings | Version Control Settings | Edit Checkout Rules

Kotlin:

```Kotlin
object GoalInBuildScripts : BuildType({
    params {
        param("branch.ignored", "refs/heads/ignored")
        param("branch.default", "refs/heads/master")
    }

    vcs {
        root(HttpsGithubComValrravnGradleSampleAppRefsHeadsMaster, "+:%\branch.default%", "-:%\branch.ignored%")
    }
})
```


## Artifact Rules

UI: Build Conf Settings | General Settings | Artifact paths

Kotlin:

```Kotlin
object GoalInBuildScripts : BuildType({
    artifactRules = "testfile1.txt => %\master.artifact.name%"
    params {
        param("master.artifact.name", "master_artifact.tar.gz")
    }
})
```





## OLD

_Build parameters_ are name-value pairs, defined by a user or provided by TeamCity, which can be used in a build. They help flexibly share settings and pass them to build steps.

This article explains how to configure build parameters. See how to [use them inside build settings and build scripts](using-build-parameters.md).

## Types of Build Parameters

There are three types of build parameters in TeamCity:
* [Environment variables](#Environment+Variables)
* [System properties](#System+Properties)
* [Configuration parameters](#Configuration+Parameters)

<anchor name="ConfiguringBuildParameters-BuildParameters"/>

### Environment Variables

Environment variables can be passed into a spawned build process as into an environment.

They are defined by the `env.` prefix.

### System Properties

System properties can be passed into build scripts of [certain runners](using-build-parameters.md#Using+Build+Parameters+in+Build+Scripts) as variables specific to a build tool.

They are defined by the `system.` prefix.

<anchor name="ConfiguringBuildParameters-ConfigurationParameters"/>

### Configuration Parameters

Configuration parameters are not passed into a build process and are only meant to share settings within a build configuration. They are the primary means for customizing a build configuration which is based on a [template](build-configuration-template.md) or uses a [meta-runner](working-with-meta-runner.md).

They come with no prefix.

<anchor name="parameter-reference"/>

## Parameter Name Restrictions

The names of configuration parameters must contain only the `[a-zA-Z0-9._-*]` characters and start with an ASCII letter.

## Predefined Build Parameters

TeamCity provides a set of _predefined parameters_ that can be used within a build configuration settings or directly inside build steps. For example, you can access the current build's number by calling the respective parameter generated by TeamCity. See the [list of predefined parameters](predefined-build-parameters.md) for details.

## Custom Build Parameters

In __Build Configuration Settings | Parameters__, project administrators can define build parameters for the current build configuration. As soon as a new build starts in this configuration, TeamCity passes these parameters to its build scripts and environment.

>It is possible to redefine the parameters' values in a single build run by launching a [custom build](running-custom-build.md).

Build parameters defined in a build configuration are used only within this configuration. See how to define them on a [project or agent level](levels-and-priority-of-build-parameters.md).

Any user-defined build parameter (<emphasis tooltip="system-property">system property</emphasis> or <emphasis tooltip="environment-variable">environment variable</emphasis>) can reference other parameters as follows: `%\system.parameter_name%` or `%\env.parameter_name%`. For example, `system.tomcat.libs=%\env.CATALINA_HOME%/lib/*.jar`.  
Read more about parameter references [below](#Parameter+References).

You can also configure a [parameter's type](typed-parameters.md), so the parameter is displayed as a UI field in the _Run Custom Build_ dialog. This way, users will be able to use the UI dialog to quickly change the parameter's value in the next build run.

## Parameter References

Most text-field settings in TeamCity support referencing a build parameter as a variable. If you enter a string in the `%\parameter.name%` format, TeamCity will substitute it with the actual value during the build.

If a build references a parameter which is not defined, TeamCity will consider it an [implicit agent requirement](agent-requirements.md#Implicit+Requirements): the build will only run on the agents where this parameter is defined.  
The references to parameters which names do not satisfy the [above restrictions](#Parameter+Name+Restrictions) do not create an [implicit requirement](agent-requirements.md#Implicit+Requirements) and are ignored.

See [where you can use parameter references](using-build-parameters.md#Where+References+Can+Be+Used).


## Check Parameter Values After a Build

When a build finishes, open the **Parameters** tab on the [](build-results-page.md) to view actual (at the time of this build) values for all parameters.

<chunk id="build-results-parameters-tab">

<img src="dk-buildParametersTab.png" width="706" alt="Build parameters tab"/>

This page has two tabs:

* **Parameters** — lists values for all configuration parameters, system properties, and environment variables. Highlights parameters that were added/modified in [custom builds](running-custom-build.md).
* **Statistic values** — lists all [statistics values](custom-chart.md#Default+Statistics+Values+Provided+by+TeamCity) reported for the build (for example, build success rate or time required to check out a remote repository). The *View Chart* button (<img src="dk-viewChart.png" width="12" alt="View Chart"/>) allows you to check how these values trend throughout build runs.

</chunk>

<seealso>
        <category ref="admin-guide">
        <a href="using-build-parameters.md">Using Build Parameters</a>
            <a href="levels-and-priority-of-build-parameters.md">Project- and Agent-Level Build Parameters</a>
            <a href="predefined-build-parameters.md">Predefined Build Parameters</a>
            <a href="typed-parameters.md">Typed Parameters</a>
            <a href="configuring-agent-requirements.md">Configuring Agent Requirements</a>
        </category>
</seealso>